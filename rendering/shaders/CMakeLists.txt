set(SHADER_PATH ${CMAKE_CURRENT_SOURCE_DIR})

file(GLOB VERTEX_SHADER_FILES "*.vert")
file(GLOB FRAGMENT_SHADER_FILES "*.frag")

set(COMPILED_VERTEX_SHADER_SUFFIX "_vert.spv")
set(COMPILED_FRAGMENT_SHADER_SUFFIX "_frag.spv")

set(SHADER_COMMANDS "cd ${SHADER_PATH}/")
set(SHADER_COMPILED_FILES "")

foreach (VERTEX_SHADER_FILE ${VERTEX_SHADER_FILES})
    get_filename_component(VERTEX_SHADER_FILENAME ${VERTEX_SHADER_FILE} NAME)
    string(REGEX REPLACE ".vert" "" VERTEX_SHADER_FILENAME_NO_EXTENSION ${VERTEX_SHADER_FILENAME})
    list(APPEND SHADER_COMPILED_FILES "${VERTEX_SHADER_FILENAME_NO_EXTENSION}${COMPILED_VERTEX_SHADER_SUFFIX}")
    list(APPEND SHADER_COMMANDS "\n${VULKAN_GLSLC_PATH} ${VERTEX_SHADER_FILENAME_NO_EXTENSION}.vert -o ${VERTEX_SHADER_FILENAME_NO_EXTENSION}${COMPILED_VERTEX_SHADER_SUFFIX}")
endforeach ()

foreach (FRAGMENT_SHADER_FILE ${FRAGMENT_SHADER_FILES})
    get_filename_component(FRAGMENT_SHADER_FILENAME ${FRAGMENT_SHADER_FILE} NAME)
    string(REGEX REPLACE ".frag" "" FRAGMENT_SHADER_FILENAME_NO_EXTENSION ${FRAGMENT_SHADER_FILENAME})
    list(APPEND SHADER_COMPILED_FILES "${FRAGMENT_SHADER_FILENAME_NO_EXTENSION}${COMPILED_FRAGMENT_SHADER_SUFFIX}")
    list(APPEND SHADER_COMMANDS "\n${VULKAN_GLSLC_PATH} ${FRAGMENT_SHADER_FILENAME_NO_EXTENSION}.frag -o ${FRAGMENT_SHADER_FILENAME_NO_EXTENSION}${COMPILED_FRAGMENT_SHADER_SUFFIX}")
endforeach ()

file(WRITE ${SHADER_PATH}/compile_shaders.bat ${SHADER_COMMANDS})

add_custom_target(
        CompileShaderCommand ALL
        COMMENT "Compiling Shaders..."
        COMMAND ${SHADER_PATH}/compile_shaders.bat
        SOURCES ${VERTEX_SHADER_FILES} ${FRAGMENT_SHADER_FILES}
)

foreach (SHADER_COMPILED_FILE ${SHADER_COMPILED_FILES})
    add_custom_command(
            TARGET CompileShaderCommand POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy
            ${SHADER_PATH}/${SHADER_COMPILED_FILE}
            ${ENGINE_BIN_DIR}/shaders/${SHADER_COMPILED_FILE}
    )
endforeach ()